{% extends "base.html" %}
{% load static %}
{% block title %}Luna-Chat | Converse com a IA{% endblock %}

{% block content %}
<body class="text-neutral-200 font-sans antialiased flex flex-col min-h-screen">

    <div class="relative min-h-screen flex overflow-hidden">

        {% include "chat_views/sidebar.html" %}

        <div id="main-content" class="flex-grow ps-64 pe-0 flex flex-col z-10 transition-all duration-300 h-screen">
            <header class="w-full p-3 ps-4 pe-4 flex justify-between items-center">
                <h3 class="text-2xl font-semibold text-white">Luna-Chat</h3>
                <a href="{% url 'logout_view' %}" class="text-white hover:text-neutral-400 transition-colors duration-300">Sair</a>
            </header>

        <div id="messages-container" class="flex-grow flex flex-col p-4 overflow-y-auto custom-scrollbar">
                {% if messages %}
                    <div id="messages-list" class="flex flex-col items-center">
                        {% for message in messages %}
                            {% if message.role == 'user' %}
                                <div class="w-full max-w-3xl mb-4 text-right">
                                    <div class="bg-neutral-600/70 text-white rounded-lg p-3 inline-block max-w-[80%] break-words">
                                        {{ message.content }}
                                    </div>
                                </div>
                            {% else %}
                                <div class="w-full max-w-3xl mb-4 text-left">
                                    <div class="rounded-lg p-3 inline-block max-w-[100%] break-words">
                                        {{ message.content }}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div id="messages-placeholder" class="flex flex-col items-center justify-center h-full">
                        <h1 class="text-4xl font-semibold text-neutral-400 fade-to-white p-4">Hey, {{ user.username }}</h1>
                    </div>
                {% endif %}
            </div>
                    
            <div class="mt-auto pb-3 w-full flex justify-center z-10">
                <form id="chat-form" class="flex flex-col w-full max-w-3xl backdrop-blur-md border border-neutral-600/80 rounded-3xl p-2">
                    {% csrf_token %}
                    <input type="file" id="file-input" name="file" class="hidden">
                    <div id="file-display" class="border border-neutral-600/70 text-white text-sm p-2 rounded-xl mb-2 hidden w-64 overflow-hidden whitespace-nowrap text-ellipsis">
                        <span id="file-name" class="truncate"></span>
                        <button type="button" id="remove-file-button" class="float-right text-neutral-400 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <input type="hidden" name="conversation_id" id="conversation_id" value="{{ current_conversation.conversation_id|default:'' }}">
                    <textarea name="prompt" id="prompt-input" placeholder="Digite sua mensagem..." class="text-neutral-200 rounded-lg py-3 px-4 focus:outline-none transition-colors duration-300 placeholder-neutral-500 resize-none h-auto min-h-[30px] max-h-[80px] w-full" rows="1"></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <button type="file" id="file-input-button" class="text-neutral-400 hover:text-neutral-200 transition-colors duration-300 hover:bg-neutral-700/50 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <line x1="12" y1="5" x2="12" y2="19" stroke-width="2" stroke-linecap="round"/>
                                <line x1="5" y1="12" x2="19" y2="12" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <button type="submit" class="bg-neutral-600 text-white font-bold py-2 px-2 rounded-3xl shadow-lg shadow-neutral-600/30 transform transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-neutral-500/50 focus:outline-none focus:ring-4 focus:ring-neutral-500/50 self-end">
                            <img src="{% static 'img/send_icon.png' %}" alt="Enviar" class="h-7 w-7">
                        </button>
                    </div>
                </form>
            </div>

            <footer class="w-full text-center pb-2">
                <p class="text-neutral-600 text-sm">Â© 2025 Luna-Chat. Todos os direitos reservados.</p>
            </footer>
        </div>
    </div>
</body>
{% endblock %}


{% block scripts %}
    {{ block.super }}
    <script>
        document.getElementById('chat-form').dataset.llmApiUrl = "{% url 'llm_stream_response' %}";
    </script>
{% endblock %}